<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<meta http-equiv="Content-Security-Policy"
      content="
        default-src 'self' data: blob:;
        img-src 'self' data: blob:;
        style-src 'self' 'unsafe-inline';
        script-src 'self' 'unsafe-inline';
        base-uri 'none';
        object-src 'none';
        frame-ancestors 'none';
      ">

<title>í‘œê³ ëª¨(í‘œì„ ê³ ë“±í•™êµì˜ ëª¨ë“ ê²ƒ) (Final v6)</title>

<style>
  :root{
    --bg:#f6f7f9; --card:#ffffff; --ink:#0f1720; --muted:#5b6774; --pri:#4f8cff; --pri-ink:#0b1222;
    --accent:#00b9a0; --danger:#ef4444; --ok:#25c280; --line:#e6e8ee; --chip:#f3f5f8; --yellow:#f5c542;
    --shadow:0 8px 24px rgba(15,23,32,.06);
  }
  .theme-dark{
    --bg:#0b0b0d; --card:#141417; --ink:#f3f4f6; --muted:#a3a3a3; --pri:#4f8cff; --pri-ink:#0b1222;
    --accent:#00d4b3; --danger:#ff5d5d; --ok:#25c280; --line:#24242a; --chip:#1b1b21; --yellow:#ffd45d;
    --shadow:0 10px 30px rgba(0,0,0,.25);
  }

  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
    font-family:ui-sans-serif,system-ui,Segoe UI,Pretendard,Apple SD Gothic Neo,Arial}
  a{color:inherit;text-decoration:none}
  button{cursor:pointer}
  img{max-width:100%;display:block}
  .wrap{max-width:1024px;margin:0 auto;padding-bottom:84px}

  @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  @keyframes pop{0%{transform:scale(.98)}100%{transform:scale(1)}}
  @media (prefers-reduced-motion: reduce){
    *{animation:none!important;transition:none!important}
  }
  
  header.appbar{position:sticky;top:0;z-index:70;display:flex;align-items:center;gap:12px;padding:14px 16px;
    background:color-mix(in srgb, var(--bg) 92%, transparent);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
  .logo{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px;letter-spacing:0.3px}
  .logo .mark{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--pri),var(--accent))}
  .grow{flex:1}
  .icon-btn{position:relative;width:36px;height:36px;border-radius:10px;background:var(--chip);display:grid;place-items:center;border:1px solid var(--line);
    transition:transform .15s ease}
  .icon-btn:hover{transform:translateY(-1px)}
  .badge-dot{position:absolute;top:-4px;right:-2px;background:var(--danger);color:#fff;border-radius:10px;font-size:10px;line-height:1;padding:3px 6px;border:1px solid #400;display:none}

  /* Search modal */
  .searchbar{display:none;position:fixed;inset:0;background:#0006;backdrop-filter:blur(2px);z-index:80}
  .searchbox{max-width:720px;margin:10vh auto;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;
    animation:fadeUp .18s ease both}
  .searchbox input{width:100%;padding:14px 16px;border-radius:10px;border:1px solid var(--line);background:var(--chip);color:var(--ink)}

  /* Banner */
  .banner{margin:12px 16px 0;background:linear-gradient(135deg,#eaf1ff,#f0fffa);border:1px solid var(--line);border-radius:16px;padding:16px;display:flex;gap:16px;align-items:center;
    box-shadow:var(--shadow)}
  .badge{display:inline-block;background:var(--pri);color:#fff;border-radius:999px;padding:4px 10px;font-size:12px;font-weight:700}
  .banner img{width:56px;height:56px;border-radius:14px;border:1px solid var(--line)}
  .banner p{margin:6px 0 0;color:#223}

  /* Sections & cards */
  .section{margin:16px}
  .section h2{margin:0 0 10px;font-size:18px}
  .cards{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .card{grid-column:span 12;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:var(--shadow);animation:fadeIn .2s ease both}
  @media(min-width:560px){.card.half{grid-column:span 6}}
  @media(min-width:900px){.card.third{grid-column:span 4}}
  .split{display:flex;gap:12px;flex-wrap:wrap}
  .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
  .muted{color:var(--muted)}
  .line{height:1px;background:var(--line);margin:10px 0}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--chip);color:var(--ink);font-weight:700}
  .btn.pri{background:var(--pri);border-color:color-mix(in srgb, var(--pri) 60%, black 40%);color:#fff}
  .btn.ghost{background:transparent}
  .tiny{font-size:11px}

  /* Calendar (meals) */
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cal-head{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:6px}
  .cal-head div{padding:8px 0;text-align:center;color:var(--muted)}
  .cal-day{border:1px solid var(--line);background:var(--chip);border-radius:10px;min-height:64px;padding:8px;cursor:pointer;display:flex;flex-direction:column;justify-content:space-between;transition:transform .12s ease}
  .cal-day:hover{transform:translateY(-1px)}
  .cal-day .num{font-weight:800}
  .cal-day .dots{display:flex;gap:4px}
  .dot{width:6px;height:6px;border-radius:999px;background:var(--accent)}
  .cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .cal-header button{background:var(--chip);border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:10px}
  .meal-detail{margin-top:10px;background:var(--chip);border:1px solid var(--line);border-radius:12px;padding:12px}

  /* ===== Timetable (calendar-like) ===== */
  .tt-wrap{display:grid;grid-template-columns:64px 1fr;gap:8px}
  .tt-hours{display:grid;gap:8px}
  .tt-hours .h{height:60px;display:grid;place-items:center;color:var(--muted);border:1px dashed var(--line);border-radius:10px;background:var(--chip)}
  .tt-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .tt-cell{position:relative;min-height:60px;background:var(--chip);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .tt-card{position:absolute;inset:4px;border-radius:10px;border:0;color:#fff;display:flex;align-items:flex-end;padding:8px;font-weight:800;box-shadow:0 10px 20px #0003;animation:pop .15s ease}
  .tt-card small{display:block;font-weight:600;opacity:.9}
  .legend{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0}
  .legend .chip{border-left:6px solid var(--pri)}

  /* News */
  .news-wrap{display:grid;gap:12px}
  .news-card{display:grid;grid-template-columns:120px 1fr;gap:12px;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
  .news-card:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
  .news-thumb{width:120px;height:80px;border-radius:10px;object-fit:cover;border:1px solid var(--line);background:#0f1320}
  .news-title{margin:0;font-weight:800}
  .news-meta{font-size:12px;color:var(--muted);margin-top:4px}
  .news-lead{margin:6px 0 0;color:color-mix(in srgb, var(--ink) 82%, transparent)}
  .article{background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden;box-shadow:var(--shadow)}
  .article .hero{width:100%;height:260px;object-fit:cover;background:#0e1220;border-bottom:1px solid var(--line)}
  .article .pad{padding:16px}
  .article h1{margin:0 0 6px}
  .article .by{color:var(--muted);font-size:13px}
  .article .body{margin-top:12px;line-height:1.7;color:color-mix(in srgb, var(--ink) 90%, transparent);white-space:pre-wrap}
  .article .actions{display:flex;gap:8px;margin-top:12px}

  /* CampusTime community */
  .ct-wrap{display:grid;grid-template-rows:auto auto 1fr;gap:12px}
  .ct-topbar{display:flex;gap:10px;align-items:center}
  .ct-logo{font-weight:800;letter-spacing:.2px}
  .ct-logo b{color:var(--pri)}
  .ct-search{flex:1;display:flex;gap:8px}
  .ct-search input{flex:1;background:var(--chip);border:1px solid var(--line);color:var(--ink);padding:10px 12px;border-radius:10px}
  .ct-search button{border:1px solid var(--line);background:var(--chip);color:var(--muted);border-radius:10px;padding:10px 12px}
  .ct-tabs{display:flex;gap:8px;flex-wrap:wrap}
  .ct-tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;color:var(--muted);cursor:pointer;background:var(--chip)}
  .ct-tab.active{background:var(--pri);border-color:transparent;color:#031020}
  .ct-composer{display:flex;gap:10px;align-items:center;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px}
  .ct-avatar{width:36px;height:36px;border-radius:50%;background:#26304222;border:1px solid var(--line)}
  .ct-composer input{flex:1;border:0;background:transparent;color:var(--muted)}
  .ct-composer button{background:var(--pri);color:#031020;border:0;padding:10px 14px;border-radius:12px;font-weight:700}
  .ct-feed{display:grid;gap:12px}
  .ct-card{background:var(--card);border:1px solid var(--line);border-radius:16px;overflow:hidden;box-shadow:var(--shadow)}
  .ct-card .head{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid var(--line)}
  .ct-meta{font-size:12px;color:var(--muted)}
  .ct-title{padding:12px 12px 0;font-weight:700}
  .ct-body{padding:8px 12px 12px;color:color-mix(in srgb, var(--ink) 90%, transparent);white-space:pre-wrap}
  .ct-actions{display:flex;gap:10px;padding:0 12px 12px;align-items:center}
  .ct-actions button{display:flex;gap:6px;align-items:center;background:var(--chip);border:1px solid var(--line);color:var(--muted);padding:8px 10px;border-radius:12px}
  .ct-reactions{display:flex;gap:8px;margin-left:4px}
  .ct-reactions button{border-radius:999px;padding:6px 10px}
  .ct-reactions button.active{outline:2px solid color-mix(in srgb, var(--pri) 65%, black 35%);background:color-mix(in srgb,var(--pri) 20%, var(--chip) 80%);color:var(--ink)}
  .ct-comments{border-top:1px solid var(--line);padding:8px 12px 12px;display:grid;gap:8px}
  .ct-comment{display:grid;grid-template-columns:32px 1fr;gap:8px}
  .ct-comment .ct-avatar{width:32px;height:32px}
  .ct-bubble{background:var(--chip);border:1px solid var(--line);border-radius:14px;padding:8px 10px}
  .ct-bubble .who{font-size:12px;color:var(--muted);margin-bottom:4px}
  .ct-empty{border:1px dashed var(--line);color:var(--muted);border-radius:14px;padding:16px;text-align:center}

  /* App list */
  .app-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  @media(min-width:700px){.app-grid{grid-template-columns:repeat(4,1fr)}}
  .app-card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px;box-shadow:var(--shadow);transition:transform .12s ease}
  .app-card:hover{transform:translateY(-1px)}
  .app-card .thumb{width:100%;height:110px;border-radius:10px;border:1px solid var(--line);object-fit:cover;background:#0f1320}
  .app-detail{margin-top:12px;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:var(--shadow)}

  /* Bottom nav */
  nav.bottom{position:fixed;left:0;right:0;bottom:0;z-index:60;background:color-mix(in srgb, var(--bg) 94%, transparent);border-top:1px solid var(--line);display:grid;grid-template-columns:repeat(5,1fr)}
  nav.bottom a{display:flex;flex-direction:column;gap:4px;align-items:center;justify-content:center;padding:10px 6px;color:var(--muted);transition:color .12s ease, transform .12s ease}
  nav.bottom a:hover{transform:translateY(-1px)}
  nav.bottom a.active{color:var(--ink);font-weight:800}

  /* Fullscreen Auth Gate */
  #gate{position:fixed;inset:0;display:grid;place-items:center;background:linear-gradient(180deg,var(--bg) 0%, color-mix(in srgb, var(--bg) 80%, black 20%) 100%);z-index:100}
  #gate .panel{width:min(620px,92vw);background:var(--card);border:1px solid var(--line);border-radius:18px;padding:20px 18px 16px;box-shadow:0 20px 60px #0002;animation:fadeUp .22s ease}
  #gate .brand{font-weight:900;font-size:22px;margin-bottom:8px}
  #gate .brand b{color:var(--pri)}
  #gate .muted{color:var(--muted);font-size:13px;margin-bottom:12px}
  #gate .row{display:grid;gap:8px;margin:10px 0}
  #gate input, #gate select, #gate textarea{width:100%;background:var(--chip);border:1px solid var(--line);color:var(--ink);padding:12px;border-radius:12px}
  #gate .actions{display:flex;align-items:center;justify-content:space-between;margin-top:8px}
  #gate .btn{background:var(--pri);color:#fff;border:0;padding:12px 14px;border-radius:12px;font-weight:800}
  #gate label{display:flex;gap:8px;align-items:center;color:var(--muted)}
  #gate .switch{margin-top:10px;font-size:13px}
  #gate .error{color:var(--danger);font-size:12px;height:16px}

  /* Notification dropdown */
  #notiPanel{position:absolute;top:46px;right:0;width:340px;background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 30px #0002;display:none;z-index:75;animation:fadeUp .16s ease}
  #notiPanel header{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid var(--line)}
  #notiPanel .tabs{display:flex;gap:8px;padding:8px}
  #notiPanel .tabs button{flex:1;border:1px solid var(--line);background:var(--chip);color:var(--ink);border-radius:999px;padding:8px}
  #notiPanel .tabs button.active{background:var(--pri);color:#031020;border-color:color-mix(in srgb, var(--pri) 60%, black 40%)}
  #notiPanel .list{max-height:280px;overflow:auto;padding:0 8px 8px}
  #notiPanel .item{border:1px solid var(--line);border-radius:10px;padding:8px;margin:8px 0;background:var(--chip);display:flex;justify-content:space-between;gap:8px;align-items:center}
  #notiPanel .empty{color:var(--muted);text-align:center;padding:18px}
  #notiPanel .admin-tools{display:none;padding:8px;border-top:1px solid var(--line)}
  #notiPanel .admin-tools .muted{margin-bottom:6px}
  #notiPanel .list .del{background:transparent;border:1px solid var(--line);border-radius:10px;padding:6px 8px}

  /* ==== ìƒˆë¡œìš´ 'ì˜¤ëŠ˜ì˜ í•  ì¼' íŠ¸ë Œë”” ì¹´ë“œ ==== */
  .todo-card{border:1px solid var(--line);background:var(--card);border-radius:16px;padding:12px;box-shadow:var(--shadow)}
  .todo-summary{display:flex;gap:8px;align-items:center}
  .todo-input-row{display:flex;gap:8px;margin-top:8px}
  .todo-input-row input{flex:1;background:var(--chip);border:1px solid var(--line);border-radius:12px;padding:10px}
  .todo-list{display:grid;gap:8px;margin-top:10px}
  .todo-item{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--line);border-radius:12px;background:var(--chip);animation:fadeIn .15s ease both}
  .todo-item .t-text{flex:1}
  .todo-item.done{opacity:.65}
  .todo-item .drag{cursor:grab}
  .todo-item .del{border:1px solid var(--line);background:transparent;border-radius:10px;padding:6px 8px}
  .check-anim{inline-size:20px;block-size:20px;border-radius:6px;border:1.5px solid var(--line);display:grid;place-items:center;transition:all .12s ease;background:var(--card)}
  .check-anim.checked{background:var(--ok);border-color:var(--ok);color:#fff}

  /* Admin floating panel (gear) */
  #adminPanel{position:fixed;right:16px;bottom:96px;z-index:65;display:none}
  #adminPanel .sheet{width:min(560px,92vw);background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:12px;animation:fadeUp .18s ease}
  #adminPanel .row{display:grid;gap:8px;margin:8px 0}
</style>
</head>
<body>
<div class="wrap" id="app">

  <!-- AppBar -->
  <header class="appbar">
    <div class="logo"><span class="mark"></span>í‘œì„ ê³  í¬í„¸</div>
    <div class="grow"></div>
    <button class="icon-btn" id="btnSearch" title="ê²€ìƒ‰">ğŸ”</button>

    <!-- Bell with dropdown -->
    <div style="position:relative">
      <button class="icon-btn" id="btnBell" title="ì•Œë¦¼">ğŸ””<span id="bellBadge" class="badge-dot">0</span></button>
      <div id="notiPanel">
        <header>
          <div><strong>ì•Œë¦¼</strong></div>
          <div class="muted tiny" id="notiHint">ì½ì§€ ì•ŠìŒë§Œ í‘œì‹œ</div>
        </header>
        <div class="tabs">
          <button data-kind="personal" class="active">ê°œì¸</button>
          <button data-kind="global">ì „ì²´</button>
        </div>
        <div class="list" id="notiList"><div class="empty">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div></div>
        <div class="admin-tools" id="notiAdmin">
          <div class="tiny muted">ê´€ë¦¬ì: ì „ì²´ ì•Œë¦¼ ë°œì†¡</div>
          <div class="split">
            <input id="notiMsg" placeholder="ë‚´ìš©" style="flex:1;background:var(--chip);border:1px solid var(--line);color:var(--ink);padding:8px;border-radius:8px">
            <button class="btn pri" id="btnBroadcast">ë°œì†¡</button>
            <button class="btn" id="btnClearAll">ëª¨ë‘ ì‚­ì œ</button>
          </div>
        </div>
      </div>
    </div>

    <button class="icon-btn" id="btnMy" title="ë‚´ ì •ë³´">ğŸ‘¤</button>
    <button class="icon-btn" id="btnAdmin" title="Admin" style="display:none">ğŸ› ï¸</button>
  </header>

  <!-- Banner -->
  <div class="banner">
    <img alt="banner" src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' width='56' height='56'><rect width='56' height='56' rx='14' fill='%234f8cff'/><text x='50%25' y='53%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-size='20'>AD</text></svg>"/>
    <div>
      <span class="badge">ë°°ë„ˆ</span>
      <p>í™ë³´í•˜ì‹œê³  ì‹¶ì€ í–‰ì‚¬ë‚˜ í™œë™ì´ ìˆìœ¼ë©´ 000ìœ¼ë¡œ ì—°ë½ì£¼ì„¸ìš”.</p>
    </div>
  </div>

  <!-- Admin floating panel -->
  <div id="adminPanel">
    <div class="sheet">
      <div class="split" style="align-items:center;justify-content:space-between">
        <strong>Admin ë„êµ¬</strong>
        <button class="btn" id="btnAdminClose">ë‹«ê¸°</button>
      </div>
      <div class="line"></div>
      <div class="row">
        <div class="tiny muted">ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œíŒ ê´€ë¦¬</div>
        <div class="split">
          <input id="admBoardName" placeholder="ê²Œì‹œíŒ ì´ë¦„ ì¶”ê°€" />
          <button class="btn" id="admAddBoard">ì¶”ê°€</button>
          <button class="btn" id="admResetBoards">ê¸°ë³¸ê°’ ë³µì›</button>
        </div>
      </div>
      <div class="row">
        <div class="tiny muted">ë°ì´í„° ê´€ë¦¬</div>
        <div class="split">
          <button class="btn" id="admClearDemo">ë°ëª¨ ë°ì´í„° ì´ˆê¸°í™”</button>
          <button class="btn" id="admGiveSampleNews">ìƒ˜í”Œ ë‰´ìŠ¤ 1ê±´ ë°œí–‰</button>
        </div>
      </div>
      <div class="row">
        <div class="tiny muted">ë¹ ë¥¸ ì•ˆë‚´</div>
        <div class="chip">ê´€ë¦¬ì ê³„ì •: admin@pyoseon.hs.kr / admin1234</div>
      </div>
    </div>
  </div>

  <!-- Dynamic view -->
  <main id="view"></main>

  <!-- Bottom nav -->
  <nav class="bottom">
    <a href="#home" data-tab="home" class="active">ğŸ <span class="tiny">í™ˆ</span></a>
    <a href="#timetable" data-tab="timetable">ğŸ“…<span class="tiny">ì‹œê°„í‘œ</span></a>
    <a href="#news" data-tab="news">ğŸ“°<span class="tiny">ë‰´ìŠ¤</span></a>
    <a href="#community" data-tab="community">ğŸ’¬<span class="tiny">ì»¤ë®¤ë‹ˆí‹°</span></a>
    <a href="#study" data-tab="study">ğŸ“<span class="tiny">í•™ì—…ì•±</span></a>
  </nav>
</div>

<!-- Search modal -->
<div class="searchbar" id="searchModal">
  <div class="searchbox">
    <input id="searchInput" placeholder="í†µí•© ê²€ìƒ‰(ê³µì§€/ë‰´ìŠ¤/ê²Œì‹œê¸€/ë„ì„œ)â€¦ Enterë¡œ ê²€ìƒ‰"/>
    <div class="line"></div>
    <div id="searchResult" class="muted" style="min-height:40px">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
      <button class="btn ghost" onclick="UI.hideSearch()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- Fullscreen Auth Gate -->
<div id="gate">
  <div class="panel">
    <div class="brand">Pyo<b>Gomo</b></div>
    <div class="muted">ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ê±°ë‚˜ ê°€ì…í•˜ì„¸ìš”.</div>
    <font size=1>ê¸€ìí¬ê¸° : 3</font></br>
    <div class="error" id="authError"></div>

    <!-- ë¡œê·¸ì¸ -->
    <div id="loginForm">
      <div class="row">
        <input id="loginEmail" type="email" placeholder="í•™êµ ì´ë©”ì¼ (ì˜ˆ: you@gmail.com)" autocomplete="username" maxlength="80"/>
        <input id="loginPass" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" maxlength="64"/>
      </div>
      <div class="actions">
        <label><input type="checkbox" id="autoLogin"/> ìë™ ë¡œê·¸ì¸(ì´ ê¸°ê¸°)</label>
        <button class="btn" id="btnLogin">ë¡œê·¸ì¸</button>
      </div>
      <div class="switch">ê³„ì •ì´ ì—†ë‚˜ìš”? <a href="#" id="goSignup">íšŒì›ê°€ì…</a></div>
    </div>

    <!-- íšŒì›ê°€ì… (+ ê³¼ëª© ê·¸ë£¹ A~G ì…ë ¥) -->
    <div id="signupForm" style="display:none">
      <div class="row">
        <select id="suGrade">
          <option value="">í•™ë…„ ì„ íƒ</option>
          <option value="1">1í•™ë…„</option>
          <option value="2">2í•™ë…„</option>
          <option value="3">3í•™ë…„</option>
        </select>
        <input id="suName" placeholder="ì´ë¦„" maxlength="20"/>
        <input id="suEmail" type="email" placeholder="í•™êµ ì´ë©”ì¼(@gmail)" maxlength="80"/>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
          <input id="suClass" type="number" min="1" placeholder="ë°˜"/>
          <input id="suNo" type="number" min="1" placeholder="ë²ˆí˜¸"/>
          <input id="suPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸(8ì ì´ìƒ)" maxlength="64"/>
        </div>
        <input id="suPw2" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" maxlength="64"/>
      </div>
      <div class="line"></div>
      <div class="tiny muted">ì„ íƒ ê³¼ëª© ê·¸ë£¹(A~G) â€” ì‰¼í‘œë¡œ êµ¬ë¶„(ì˜ˆ: ìˆ˜í•™, ì˜ì–´, êµ­ì–´). 2Â·3í•™ë…„ ì‹œê°„í‘œ ìë™ ë°°ì¹˜ì— ì‚¬ìš©ë©ë‹ˆë‹¤.</div>
      <div class="row" style="grid-template-columns:repeat(2,1fr);">
        <input id="suGA" value="Aê·¸ë£¹" />
        <input id="suGB" value="Bê·¸ë£¹" />
        <input id="suGC" value="Cê·¸ë£¹" />
        <input id="suGD" value="Dê·¸ë£¹" />
        <input id="suGE" value="Eê·¸ë£¹" />
        <input id="suGF" value="Gê·¸ë£¹" />
        <input id="suGG" value="ì˜¤ë°¥ì´" />
      </div>
      <div class="actions">
        <span></span>
        <button class="btn" id="btnSignup">ê°€ì…í•˜ê¸°</button>
      </div>
      <div class="switch">ì´ë¯¸ ê³„ì •ì´ ìˆë‚˜ìš”?<a href="#" id="goLogin">ë¡œê·¸ì¸ìœ¼ë¡œ</a></div>
    </div>
  </div>
</div>

<!-- Community write modal -->
<div class="ct-modal" id="ctModal" style="display:none;place-items:center;position:fixed;inset:0;background:#0006;z-index:90">
  <div class="ct-sheet" style="width:min(680px,92vw);background:var(--card);border:1px solid var(--line);border-radius:18px;overflow:hidden;box-shadow:var(--shadow);animation:fadeUp .18s ease">
    <header><div class="ct-topbar"><div class="ct-logo">ìƒˆ ê¸€ ì“°ê¸°</div><div class="ct-meta">ë¡œì»¬ ì €ì¥</div></div></header>
    <div class="row" style="padding:12px"><select id="ctBoard" style="width:100%;background:var(--chip);border:1px solid var(--line);color:var(--ink);padding:10px 12px;border-radius:12px"></select></div>
    <div class="row" style="padding:12px"><input id="ctTitle" placeholder="ì œëª© (ì„ íƒ)" style="width:100%;background:var(--chip);border:1px solid var(--line);color:var(--ink);padding:10px 12px;border-radius:12px"/></div>
    <div class="row" style="padding:12px"><textarea id="ctBody" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:100%;min-height:140px;resize:vertical;background:var(--chip);border:1px solid var(--line);color:var(--ink);padding:10px 12px;border-radius:12px"></textarea></div>
    <div class="row" style="padding:12px"><input id="ctAuthor" placeholder="ì‘ì„±ì (ì˜ˆ: ìµëª…, ë‹‰ë„¤ì„)" style="width:100%;background:var(--chip);border:1px solid var(--line);color:var(--ink);padding:10px 12px;border-radius:12px"/></div>
    <div class="actions" style="padding:12px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" id="ctCancel">ì·¨ì†Œ</button>
      <button class="btn pri" id="ctSubmit">ë“±ë¡</button>
    </div>
  </div>
</div>

<script>
/* ========= Utils & Storage ========= */
const Store = {
  get(k, fallback){ try{ return JSON.parse(localStorage.getItem(k)) ?? fallback }catch{ return fallback } },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)) },
  del(k){ localStorage.removeItem(k) }
};
const fmtDate = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
const now = ()=>new Date();
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

/* ========= First-run seeds ========= */
(function initEmpty(){
  const keys = ['todos','notices','calendar','library','meals','timetable','friends','news','notifs'];
  keys.forEach(k=>{
    if(Store.get(k)===undefined){
      if(k==='timetable') Store.set(k,{owner:'ë‚˜ì˜ ì‹œê°„í‘œ', grid:[...Array(8)].map(()=>Array(5).fill('')), setup:null});
      else if(k==='meals') Store.set(k,{});
      else if(k==='notifs') Store.set(k,{personal:[], global:[]});
      else Store.set(k, []);
    }
  });
  // Users/session
  if(!Store.get('users')){
    const adminEmail='admin@pyoseon.hs.kr';
    const adminHash='5ce3a72eaf1436496b626bed99dc6d8cbfabf0404300f5ed250b60585b12de6a'; // salted(admin@..:admin1234:p0rtal#pep)
    Store.set('users', [
      { email:adminEmail, name:'ê´€ë¦¬ì', pwHash:adminHash, role:'admin', grade:3, classNo:1, studentNo:1,
        settings:{theme:'light', pushPersonal:true, pushGlobal:true, shareTimetable:true},
        timetableShared:null,
        subjectGroups:{A:['ìˆ˜í•™','ì˜ì–´','êµ­ì–´'],B:['ì²´ìœ¡','ìŒì•…','ë¯¸ìˆ '],C:['ë¬¼ë¦¬í•™â… ','í™”í•™â… ','ìƒëª…ê³¼í•™â… '],D:['ì§€êµ¬ê³¼í•™â… ','ì‚¬íšŒë¬¸í™”','ê²½ì œ'],E:['ì„¸ê³„ì‚¬','ë™ì•„ì‹œì•„ì‚¬','í•œêµ­ì§€ë¦¬'],F:['ì •ë³´','ê¸°ìˆ Â·ê°€ì •','ì§„ë¡œí™œë™'],G:['ì¼ë³¸ì–´â… ','ì¤‘êµ­ì–´â… ','í•œë¬¸â… ']}
      }
    ]);
  }
  if(!Store.get('session')) Store.set('session', { email:null, auto:false });

  // ë‰´ìŠ¤ ì˜ˆì‹œ
  if((Store.get('news',[])||[]).length===0){
    const demo = {
      id: crypto.randomUUID?.() || Math.random().toString(36).slice(2),
      section: 'ìº í¼ìŠ¤',
      title: 'í•™ìƒíšŒ, ê°€ì„ ì¶•ì œ ì¤€ë¹„ìœ„ì›íšŒ ì¶œë²”',
      lead: 'í•™ìƒ ì°¸ì—¬ ì¤‘ì‹¬ì˜ ì¶•ì œë¥¼ ìœ„í•´ ë³¸ê²© ì‹œë™ì„ ê±¸ì—ˆìŠµë‹ˆë‹¤.',
      thumb: '',
      body: 'ì˜¬í•´ ê°€ì„ ì¶•ì œ ì¤€ë¹„ìœ„ì›íšŒê°€ ê³µì‹ ì¶œë²”í–ˆìŠµë‹ˆë‹¤.\ní•™ìƒíšŒëŠ” ì´ë²ˆ ì£¼ë¶€í„° ë¶€ìŠ¤ ì‹ ì²­ì„ ë°›ê³ , ì•ˆì „/ì²­ê²° ì§€ì¹¨ì„ ì‚¬ì „ì— ê³µì§€í•  ì˜ˆì •ì…ë‹ˆë‹¤.\nì„¸ë¶€ ì¼ì •ê³¼ ë¼ì¸ì—…ì€ 9ì›” ì´ˆ ê³µê°œë©ë‹ˆë‹¤.',
      authorEmail: 'admin@pyoseon.hs.kr',
      authorName: 'ê´€ë¦¬ì',
      date: fmtDate(now()),
      ts: Date.now()
    };
    Store.set('news',[demo]);
  }
})();

/* ========= Crypto / Security ========= */
async function sha256Hex(txt){ const enc=new TextEncoder().encode(txt); const buf=await crypto.subtle.digest('SHA-256', enc); return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('') }
const PEPPER = 'p0rtal#pep';
async function pwHashFor(email, pw){ return sha256Hex(`${email}:${pw}:${PEPPER}`) }
const LoginGuard = {
  key:'login_guard',
  get(){ return Store.get(this.key,{}) },
  set(v){ Store.set(this.key,v) },
  canTry(email){
    const g=this.get()[email]||{fails:0,lockUntil:0};
    if(Date.now()<g.lockUntil) return {ok:false, wait:g.lockUntil-Date.now()};
    return {ok:true}
  },
  fail(email){
    const map=this.get(); const g=map[email]||{fails:0,lockUntil:0};
    g.fails++; if(g.fails>=5){ g.lockUntil=Date.now()+5*60*1000; g.fails=0; }
    map[email]=g; this.set(map);
  },
  success(email){ const map=this.get(); delete map[email]; this.set(map); }
};

/* ========= Auth ========= */
const Auth = {
  user(){ const s=Store.get('session',{email:null}); if(!s.email) return null; return (Store.get('users',[]).find(u=>u.email===s.email) || null) },
  role(){ return this.user()?.role || 'user' },
  isAdmin(){ return this.role()==='admin' },
  async login(email, pw, auto){
    const can=LoginGuard.canTry(email); if(!can.ok) throw new Error(`ë³´ì•ˆ ëŒ€ê¸°ì¤‘: ${Math.ceil(can.wait/1000)}ì´ˆ í›„ ì¬ì‹œë„`);
    const users=Store.get('users',[]); const u=users.find(x=>x.email===email);
    if(!u){ LoginGuard.fail(email); throw new Error('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê³„ì •ì…ë‹ˆë‹¤.'); }
    const salted=await pwHashFor(email,pw);
    const legacy=await sha256Hex(pw);
    if(u.pwHash!==salted && u.pwHash!==legacy){ LoginGuard.fail(email); throw new Error('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); }
    LoginGuard.success(email);
    Store.set('session',{email, auto:!!auto}); if(auto) localStorage.setItem('autoLogin','1'); else localStorage.removeItem('autoLogin');
  },
  async signup({grade,name,email,cls,no,pw,pw2,groups}){
    if(!grade) throw new Error('í•™ë…„ì„ ì„ íƒí•˜ì„¸ìš”.');
    if(!name) throw new Error('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) throw new Error('ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    if(!cls || !no) throw new Error('ë°˜/ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    if(pw.length<8) throw new Error('ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
    if(pw!==pw2) throw new Error('ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    const users=Store.get('users',[]); if(users.some(u=>u.email===email)) throw new Error('ì´ë¯¸ ë“±ë¡ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.');
    const pwHash=await pwHashFor(email,pw);
    const role = (email==='admin@pyoseon.hs.kr')?'admin':'user';
    users.push({email, name, pwHash, role, grade:parseInt(grade,10), classNo:parseInt(cls,10), studentNo:parseInt(no,10),
                settings:{theme:'light', pushPersonal:true, pushGlobal:true, shareTimetable:false},
                timetableShared:null,
                subjectGroups:groups});
    Store.set('users', users); Store.set('session', {email, auto:true}); localStorage.setItem('autoLogin','1');
  },
  logout(){ Store.set('session',{email:null, auto:false}); localStorage.removeItem('autoLogin'); }
};

/* ========= Theme apply ========= */
function applyUserTheme(){
  const u = Auth.user();
  const wantDark = (u?.settings?.theme === 'dark');
  document.documentElement.classList.toggle('theme-dark', wantDark);
  // Admin gear visible?
  document.getElementById('btnAdmin').style.display = Auth.isAdmin()? 'grid':'none';
}

/* ========= Gate UI ========= */
const gate = document.getElementById('gate');
const authError = document.getElementById('authError');
const loginForm = document.getElementById('loginForm');
const signupForm = document.getElementById('signupForm');
document.getElementById('btnLogin').onclick = async()=>{
  const email = document.getElementById('loginEmail').value.trim();
  const pw    = document.getElementById('loginPass').value;
  const auto  = document.getElementById('autoLogin').checked;
  try{ await Auth.login(email,pw,auto); authError.textContent=''; showApp(true); }catch(e){ authError.textContent=e.message }
};
document.getElementById('goSignup').onclick=(e)=>{e.preventDefault();loginForm.style.display='none';signupForm.style.display='block';authError.textContent='';};
document.getElementById('goLogin').onclick=(e)=>{e.preventDefault();signupForm.style.display='none';loginForm.style.display='block';authError.textContent='';};
document.getElementById('btnSignup').onclick = async()=>{
  try{
    const groups = ['A','B','C','D','E','F','G'].reduce((acc,g)=>{
      const v = document.getElementById('suG'+g).value.split(',').map(s=>s.trim()).filter(Boolean).slice(0,3);
      acc[g]=v; return acc;
    },{});
    const data = {
      grade: document.getElementById('suGrade').value,
      name : document.getElementById('suName').value.trim(),
      email: document.getElementById('suEmail').value.trim(),
      cls  : document.getElementById('suClass').value,
      no   : document.getElementById('suNo').value,
      pw   : document.getElementById('suPw').value,
      pw2  : document.getElementById('suPw2').value,
      groups
    };
    await Auth.signup(data); authError.textContent=''; showApp(true);
  }catch(e){ authError.textContent = e.message }
};

function showApp(tryAuto=false){
  const s=Store.get('session',{email:null,auto:false}); const hasAuto=localStorage.getItem('autoLogin')==='1';
  if((tryAuto && hasAuto && s.email) || s.email){ gate.style.display='none'; applyUserTheme(); Router.render(); Noti.updateBadge(); }
  else{ gate.style.display='grid'; }
}

/* ========= UI helpers ========= */
const UI = {
  toast(t){ const el=document.createElement('div'); el.textContent=t; Object.assign(el.style,{position:'fixed',left:'50%',bottom:'84px',transform:'translateX(-50%)',background:'var(--card)',border:'1px solid var(--line)',padding:'10px 14px',borderRadius:'10px',zIndex:95,boxShadow:'var(--shadow)',animation:'fadeUp .16s ease'}); document.body.appendChild(el); setTimeout(()=>el.remove(),1600); },
  showSearch(){ document.getElementById('searchModal').style.display='block'; document.getElementById('searchInput').focus() },
  hideSearch(){ document.getElementById('searchModal').style.display='none'; },
  ad(label='ê´‘ê³ /ë°°ë„ˆ ìœ„ì¹˜'){ return `<div class="ad">(${label})</div>`; }
};

/* ========= Router ========= */
const Router = {
  mount: document.getElementById('view'),
  tabs: [...document.querySelectorAll('nav.bottom a')],
  render(){
    let hash = location.hash.replace('#','') || 'home';
    if(hash.startsWith('news-')) hash = 'news';
    this.tabs.forEach(a=>a.classList.toggle('active', a.dataset.tab===hash));
    const views = { home: ViewHome, timetable: ViewTimetable, news: ViewNews, community: ViewCommunity, study: ViewStudy, me: ViewMe };
    (views[hash]||ViewHome)();
  }
};

/* ========= Home ========= */
function ViewHome(){
  Router.mount.innerHTML = `
    <section class="section">
      <h2>í™ˆ</h2>
      <div class="cards">
        <div class="card half">
          <div class="split" style="align-items:center;justify-content:space-between">
            <div><strong>ë“±ê¸‰ ê³„ì‚°ê¸°</strong><div class="muted tiny">í•™ë…„ ê¸°ì¤€: 1í•™ë…„=5ë“±ê¸‰ì œ, 2Â·3í•™ë…„=9ë“±ê¸‰ì œ</div></div>
            <div class="split">
              <input id="popTotal" type="number" min="1" placeholder="ì „ì²´ ì¸ì›(ëª…ìˆ˜)" class="btn"/>
              <button class="btn pri" onclick="GradeCalc.calc()">ê³„ì‚°</button>
            </div>
          </div>
          <div id="gradeInfo" class="tiny muted" style="margin-top:6px"></div>
          <div class="line"></div>
          <div id="gradeTable" class="muted tiny">ì „ì²´ ì¸ì›ì„ ì…ë ¥í•´ ë³´ì„¸ìš”.</div>
        </div>

        <!-- === ì˜¤ëŠ˜ì˜ í•  ì¼ (ì‹ ê·œ UI) === -->
        <div class="card half">
          <div class="split" style="align-items:center;justify-content:space-between">
            <div class="todo-summary">
              <strong>ì˜¤ëŠ˜ì˜ í•  ì¼</strong>
              <span class="chip" id="todoSummary">0/0 ì™„ë£Œ</span>
            </div>
            <div class="split">
              <button class="btn" onclick="Todo.clearDone()">ì™„ë£Œ ì •ë¦¬</button>
              <button class="btn" onclick="Todo.clearAll()">ì „ì²´ ì‚­ì œ</button>
            </div>
          </div>
          <div class="todo-card">
            <div class="todo-input-row">
              <input id="todoInput" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ê³  Enter" onkeydown="if(event.key==='Enter') Todo.add()" />
              <button class="btn pri" onclick="Todo.add()">ì¶”ê°€</button>
            </div>
            <div id="todoList" class="todo-list"></div>
          </div>
        </div>

        <div class="card third">
          <strong>í•™êµ ê³µì§€</strong>
          <ul class="list" id="noticeList"><li class="muted" style="width:100%">ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</li></ul>
        </div>

        <div class="card third">
          <strong>í•™ì‚¬ ì¼ì •</strong>
          <ul class="list" id="calList"><li class="muted" style="width:100%">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</li></ul>
        </div>

        <div class="card third">
          <strong>ë„ì„œê´€</strong>
          <ul class="list" id="libList"><li class="muted" style="width:100%">ë“±ë¡ëœ ì†Œì‹ì´ ì—†ìŠµë‹ˆë‹¤.</li></ul>
        </div>

        <div class="card">
          <div class="split" style="align-items:center;justify-content:space-between">
            <div><strong>ê¸‰ì‹í‘œ</strong></div>
            <div class="split">
              <button class="btn" onclick="Meal.prevMonth()">ì´ì „</button>
              <button class="btn" onclick="Meal.nextMonth()">ë‹¤ìŒ</button>
            </div>
          </div>
          <div id="mealCalendar"></div>
          <div id="mealDetail" class="meal-detail" style="display:none"></div>
        </div>
      </div>
    </section>`;
  GradeCalc.renderInfo(); Todo.render(); Meal.render();
}
const GradeCalc = {
  dist5:[20,20,20,20,20],
  dist9:[4,7,12,17,20,17,12,7,4],
  renderInfo(){ const u=Auth.user(); const g=u?.grade||1; const tag=(g==1)?'5ë“±ê¸‰':'9ë“±ê¸‰'; document.getElementById('gradeInfo').innerHTML=`í˜„ì¬ í”„ë¡œí•„ í•™ë…„: <b>${g}í•™ë…„</b> â†’ <b>${tag}</b> ê¸°ì¤€`; },
  calc(){
    const total=parseInt(document.getElementById('popTotal').value,10)||0; const u=Auth.user(); const g=u?.grade||1;
    if(total<=0){ UI.toast('ì „ì²´ ì¸ì›ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
    const dist=(g==1)?this.dist5:this.dist9;
    let remain=total;
    const rows = dist.map((pct,i)=>{
      const cnt = Math.round(total*pct/100);
      remain -= cnt;
      return {label:`${i+1}ë“±ê¸‰`, pct, cnt};
    });
    if(remain!==0){ rows[rows.length-1].cnt += remain; }
    const html = `
      <div class="tiny muted">ì´ì› ${total}ëª… ê¸°ì¤€</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:8px">
        ${rows.map(r=>`<div class="chip" style="justify-content:space-between"><span>${r.label}</span><span>${r.pct}% Â· ${r.cnt}ëª…</span></div>`).join('')}
      </div>`;
    document.getElementById('gradeTable').innerHTML = html;
  }
};
const Todo = {
  key:'todos',
  render(){ const wrap=document.getElementById('todoList'); const todos=Store.get(this.key,[]); const done=todos.filter(t=>t.done).length;
    document.getElementById('todoSummary').textContent=`${done}/${todos.length} ì™„ë£Œ`;
    wrap.innerHTML = (todos.length? todos.map(t=>`
      <div class="todo-item ${t.done?'done':''}" data-id="${t.id}">
        <div class="check-anim ${t.done?'checked':''}" onclick="Todo.toggle(${t.id})">${t.done?'âœ“':''}</div>
        <div class="t-text">${this.escape(t.text)}</div>
        <button class="del" title="ì‚­ì œ" onclick="Todo.remove(${t.id})">ğŸ—‘</button>
      </div>`).join('') : `<div class="muted">í•  ì¼ì„ ì¶”ê°€í•´ ë³´ì„¸ìš”.</div>`);
  },
  escape(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))},
  add(){ const inp=document.getElementById('todoInput'); const text=inp.value.trim(); if(!text) return;
    const todos=Store.get(this.key,[]); const id=(todos.at(-1)?.id||0)+1; todos.push({id,text,done:false}); Store.set(this.key,todos); inp.value=''; this.render();
  },
  toggle(id){ const todos=Store.get(this.key,[]).map(t=>t.id===id?({...t,done:!t.done}):t); Store.set(this.key,todos); this.render(); },
  remove(id){ const todos=Store.get(this.key,[]).filter(t=>t.id!==id); Store.set(this.key,todos); this.render(); },
  clearDone(){ const todos=Store.get(this.key,[]).filter(t=>!t.done); Store.set(this.key,todos); this.render(); },
  clearAll(){ Store.set(this.key,[]); this.render(); }
};
const Meal = {
  cursor: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
  render(){
    const y=this.cursor.getFullYear(), m=this.cursor.getMonth(), first=new Date(y,m,1), last=new Date(y,m+1,0);
    const head=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].map(d=>`<div>${d}</div>`).join(''); let days=''; const offset=first.getDay();
    for(let i=0;i<offset;i++) days+=`<div></div>`;
    for(let d=1; d<=last.getDate(); d++){
      const dateStr=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const has=Store.get('meals',{})[dateStr];
      days+=`<div class="cal-day" onclick="Meal.open('${dateStr}')"><div class="num">${d}</div><div class="dots">${has?'<span class="dot"></span><span class="dot"></span>':''}</div></div>`;
    }
    document.getElementById('mealCalendar').innerHTML = `
      <div class="cal-header">
        <div></div>
        <div style="text-align:center;font-weight:800">${y}.${String(m+1).padStart(2,'0')}</div>
        <div style="text-align:right"><button onclick="Meal.prevMonth()">&lt;</button><button onclick="Meal.nextMonth()">&gt;</button></div>
      </div>
      <div class="cal-head">${head}</div><div class="calendar">${days}</div>`;
  },
  open(dateStr){ const data=Store.get('meals',{})[dateStr]; const box=document.getElementById('mealDetail');
    if(!data){ box.style.display='block'; box.innerHTML='<div class="muted">ë“±ë¡ëœ ê¸‰ì‹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    box.style.display='block';
    box.innerHTML = `<strong>${dateStr} ê¸‰ì‹</strong>
      <div class="split" style="margin-top:6px;gap:18px">
        <div><div class="chip">ì¤‘ì‹</div><div class="muted">${data.lunch.join(' Â· ')}</div></div>
        <div><div class="chip">ì„ì‹</div><div class="muted">${data.dinner.join(' Â· ')}</div></div>
      </div>`;
  },
  prevMonth(){ this.cursor = new Date(this.cursor.getFullYear(), this.cursor.getMonth()-1, 1); this.render(); },
  nextMonth(){ this.cursor = new Date(this.cursor.getFullYear(), this.cursor.getMonth()+1, 1); this.render(); }
};

/* ========= Timetable ========= */
const GROUP_SLOT_SETS = [
  /* Set 1 (ê¸°ë³¸) */ {A:[[1,0],[3,2]], B:[[2,1],[4,3]], C:[[0,2],[5,4]], D:[[3,0],[1,3]], E:[[4,1],[2,4]], F:[[5,2],[0,1]], G:[[1,4],[3,1]]},
  /* Set 2 */        {A:[[0,0],[2,2]], B:[[1,1],[3,3]], C:[[2,0],[4,2]], D:[[3,1],[5,3]], E:[[4,0],[1,4]], F:[[5,1],[0,3]], G:[[0,4],[2,1]]},
  /* Set 3 */        {A:[[1,2],[4,0]], B:[[2,3],[5,1]], C:[[0,1],[3,4]], D:[[3,2],[1,0]], E:[[4,3],[2,2]], F:[[5,4],[0,0]], G:[[1,1],[2,4]]},
  /* Set 4 */        {A:[[2,0],[5,2]], B:[[0,3],[3,1]], C:[[1,4],[4,2]], D:[[3,3],[1,2]], E:[[4,1],[2,3]], F:[[5,0],[0,2]], G:[[2,1],[4,4]]},
  /* Set 5 */        {A:[[0,2],[4,1]], B:[[1,3],[5,2]], C:[[2,4],[3,0]], D:[[3,2],[0,0]], E:[[4,3],[1,1]], F:[[5,4],[2,2]], G:[[1,0],[3,4]]},
  /* Set 6 */        {A:[[1,1],[4,3]], B:[[2,2],[5,0]], C:[[0,0],[3,2]], D:[[3,4],[2,1]], E:[[4,2],[1,3]], F:[[5,1],[0,4]], G:[[2,3],[4,0]]},
];
function buildGridFromSelections(selections, baseGrid=null, setIndex=0){
  const slotsMap = GROUP_SLOT_SETS[setIndex] || GROUP_SLOT_SETS[0];
  const grid = baseGrid? JSON.parse(JSON.stringify(baseGrid)) : [...Array(8)].map(()=>Array(5).fill(''));
  selections.forEach(sel=>{
    const slots = slotsMap[sel.group];
    if(!slots) return;
    slots.forEach(([p,d])=>{
      if(grid[p] && grid[p][d]==='') grid[p][d]=sel.subject;
      else{
        let pp=p; while(pp<grid.length && grid[pp][d]!=='') pp++;
        if(pp<grid.length) grid[pp][d]=sel.subject;
      }
    });
  });
  return grid;
}
const FIRST_GRADE_TEMPLATE = {
  'êµ­ì–´':[ [0,0],[2,2] ],
  'ìˆ˜í•™':[ [1,1],[3,3] ],
  'ì˜ì–´':[ [2,0],[4,2] ],
  'í•œêµ­ì‚¬':[ [0,3] ],
  'í†µí•©ê³¼í•™':[ [1,2],[5,4] ],
  'ì²´ìœ¡':[ [4,0] ],
};
function buildFirstGradeGrid(){
  const grid=[...Array(8)].map(()=>Array(5).fill(''));
  Object.entries(FIRST_GRADE_TEMPLATE).forEach(([sub,slots])=>{
    slots.forEach(([p,d])=>{ grid[p][d]=sub; });
  });
  return grid;
}

function ViewTimetable(){
  const tt=Store.get('timetable');
  Router.mount.innerHTML = `
    <section class="section">
      <div class="split" style="justify-content:space-between;align-items:center">
        <h2>${tt.owner}</h2>
        <div class="split">
          <button class="btn pri" onclick="TT.setupOpen()">ì‹œê°„í‘œ ì„¤ì •/ì¬ì„¤ì •</button>
          <button class="btn" onclick="TT.openFriend()">ì¹œêµ¬ ì‹œê°„í‘œ ë³´ê¸°</button>
        </div>
      </div>
      <div class="legend"><span class="chip">2Â·3í•™ë…„: ì„ íƒê³¼ëª© + A~G ê·¸ë£¹ ì…ë ¥ â†’ ë°°ì¹˜ ì„¸íŠ¸(1~6) ì„ íƒ</span><span class="chip">1í•™ë…„: ê³µí†µ í…œí”Œë¦¿ ìë™ ë°°ì¹˜</span></div>
      <div id="ttGrid"></div>
      <div id="friendList" class="card" style="display:none;margin-top:12px">
        <strong>ì¹œêµ¬ ì‹œê°„í‘œ</strong>
        <div class="line"></div>
        <div class="split">
          <input id="friendQuery" class="btn" placeholder="ì¹œêµ¬ ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰"/>
          <button class="btn" onclick="TT.searchFriend()">ê²€ìƒ‰</button>
        </div>
        <div id="friendResults" class="split tiny muted" style="margin-top:8px">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
        <div id="friendView" style="margin-top:10px"></div>
      </div>
    </section>`;
  TT.render();
}
const TT = {
  colorFor(subj){ const seed=Array.from(subj||'').reduce((a,c)=>a+c.charCodeAt(0),0); const hue= seed%360; return `linear-gradient(135deg,hsl(${hue} 65% 45%), hsl(${hue} 70% 55%))` },
  render(){
    const tt=Store.get('timetable'); const days=['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ']; const grid=tt.grid; const rows=grid.length;
    const hoursCol = Array.from({length:rows},(_,i)=>`<div class="h">${i+1}êµì‹œ</div>`).join('');
    let gridHtml='';
    for(let r=0;r<rows;r++){
      for(let c=0;c<5;c++){
        const subj=grid[r][c];
        gridHtml += `<div class="tt-cell">${ subj ? `<div class="tt-card" style="background:${this.colorFor(subj)}"><div>${subj}<small>${days[c]} Â· ${r+1}êµì‹œ</small></div></div>` : ''}</div>`;
      }
    }
    document.getElementById('ttGrid').innerHTML = `
      <div class="tt-wrap">
        <div class="tt-hours">${hoursCol}</div>
        <div class="tt-grid">${gridHtml}</div>
      </div>`;
  },
  setupOpen(){
    const u=Auth.user(); const g=u?.grade||1;
    const modal=document.createElement('div');
    modal.style.cssText='position:fixed;inset:0;background:#0006;display:grid;place-items:center;z-index:90';
    modal.innerHTML = `
      <div style="width:min(720px,92vw);background:var(--card);border:1px solid var(--line);border-radius:18px;padding:14px;box-shadow:var(--shadow)">
        <div class="split" style="align-items:center;justify-content:space-between">
          <strong>ì‹œê°„í‘œ ì„¤ì •</strong><span class="muted tiny">í•™ë…„: ${g}í•™ë…„</span>
        </div>
        <div class="line"></div>
        <div id="setupArea"></div>
        <div class="split" style="justify-content:flex-end;margin-top:10px">
          <button class="btn" id="btnCancel">ì·¨ì†Œ</button>
          <button class="btn pri" id="btnSave">ì €ì¥</button>
        </div>
      </div>`;
    document.body.appendChild(modal);

    const area=modal.querySelector('#setupArea');
    if(g==1){
      area.innerHTML = `
        <div class="muted tiny">1í•™ë…„ì€ ê³µí†µ í…œí”Œë¦¿ìœ¼ë¡œ ìë™ ë°°ì¹˜ë©ë‹ˆë‹¤. í•„ìš” ì‹œ ê³¼ëª©ì„ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”.</div>
        <div class="line"></div>
        <div id="firstList"></div>
        <div class="split" style="margin-top:6px">
          <input id="addSub1" class="btn" placeholder="ì¶”ê°€ ê³¼ëª©ëª…"/>
          <button class="btn" id="btnAdd1">ê³¼ëª© ì¶”ê°€</button>
        </div>`;
      const list = Object.keys(FIRST_GRADE_TEMPLATE);
      const renderList=()=>{ modal.querySelector('#firstList').innerHTML = list.map((s,i)=>`<div class="chip" style="justify-content:space-between;gap:12px">${s}<button class="btn" onclick="this.parentElement.remove();">${'ì‚­ì œ'}</button></div>`).join('') || '<div class="muted tiny">ê³µí†µ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; };
      renderList();
      modal.querySelector('#btnAdd1').onclick=()=>{ const v=modal.querySelector('#addSub1').value.trim(); if(!v) return; list.push(v); modal.querySelector('#addSub1').value=''; renderList(); };
      modal.querySelector('#btnSave').onclick=()=>{
        let grid=buildFirstGradeGrid();
        const extras = Array.from(modal.querySelectorAll('#firstList .chip')).map(x=>x.firstChild.textContent).filter(s=>!(s in FIRST_GRADE_TEMPLATE));
        if(extras.length){ grid = buildGridFromSelections(extras.map(e=>({subject:e, group:'G'})), grid, 0); }
        const tt=Store.get('timetable'); tt.grid=grid; tt.setup={grade:g, type:'first', subjects:extras}; Store.set('timetable',tt);
        UI.toast('ì‹œê°„í‘œê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤'); modal.remove(); TT.render();
      };
    }else{
      // 2Â·3í•™ë…„: ë°°ì¹˜ ì„¸íŠ¸ ì„ íƒ + A~G ê·¸ë£¹ ìë™ ë³€í™˜
      const myGroups = (u?.subjectGroups) || {A:[],B:[],C:[],D:[],E:[],F:[],G:[]};
      area.innerHTML = `
        <div class="muted tiny">ì„ íƒê³¼ëª©ì„ í™•ì¸í•˜ê³ , ë°°ì¹˜ ì„¸íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”. A~G ê·¸ë£¹ë³„ ê³¼ëª©ì´ ìë™ ë°°ì¹˜ë©ë‹ˆë‹¤.</div>
        <div class="line"></div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px" id="selList">
          ${Object.entries(myGroups).map(([g,arr])=>`
            <div class="card" style="grid-column:span 1;padding:10px">
              <div><b>${g} ê·¸ë£¹</b></div>
              <div class="tiny muted">ê³¼ëª©(${arr.length}):</div>
              <div class="split" style="margin-top:6px">${arr.map(s=>`<span class="chip">${CT.escape(s)}</span>`).join('')||'<span class="muted tiny">ì—†ìŒ</span>'}</div>
            </div>`).join('')}
        </div>
        <div class="line"></div>
        <div class="split" style="align-items:center">
          <label class="chip">ë°°ì¹˜ ì„¸íŠ¸:
            <select id="setIndex" class="btn">
              <option value="0">1</option><option value="1">2</option><option value="2">3</option>
              <option value="3">4</option><option value="4">5</option><option value="5">6</option>
            </select>
          </label>
        </div>`;
      modal.querySelector('#btnSave').onclick=()=>{
        const setIndex=parseInt(modal.querySelector('#setIndex').value,10)||0;
        const selections=[];
        Object.entries(myGroups).forEach(([grp,arr])=> arr.forEach(sub=> selections.push({subject:sub, group:grp})));
        const grid=buildGridFromSelections(selections, null, setIndex);
        const tt=Store.get('timetable'); tt.grid=grid; tt.setup={grade:g, type:'elective', setIndex, selections}; Store.set('timetable',tt);
        // ê³µìœ  ì €ì¥
        const users=Store.get('users',[]); const me=users.find(x=>x.email===u.email);
        me.timetableShared = { grid, updated: Date.now() }; Store.set('users', users);
        UI.toast('ì‹œê°„í‘œê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤'); modal.remove(); TT.render();
      };
    }
    modal.querySelector('#btnCancel').onclick=()=>modal.remove();
  },
  openFriend(){ document.getElementById('friendList').style.display='block'; },
  searchFriend(){
    const q=document.getElementById('friendQuery').value.trim(); const users=Store.get('users',[]); const me=Auth.user();
    const res = users.filter(u=>u.settings?.shareTimetable && u.timetableShared && u.name.includes(q) && u.email!==me.email);
    const box=document.getElementById('friendResults');
    box.className='split';
    box.innerHTML = res.length? res.map(u=>`<button class="btn" onclick="TT.showFriend('${u.email}')">${u.name} Â· ${u.grade}í•™ë…„</button>`).join(' ') : '<span class="muted tiny">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
  },
  showFriend(email){
    const u=Store.get('users',[]).find(x=>x.email===email); if(!u||!u.timetableShared){ UI.toast('í•´ë‹¹ ì¹œêµ¬ê°€ ê³µìœ ë¥¼ êº¼ë‘ì—ˆê±°ë‚˜ ì‹œê°„í‘œê°€ ì—†ìŠµë‹ˆë‹¤'); return; }
    const grid=u.timetableShared.grid; const days=['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ']; const rows=grid.length;
    let gridHtml=''; for(let r=0;r<rows;r++){ for(let c=0;c<5;c++){ const subj=grid[r][c]; gridHtml += `<div class="tt-cell">${ subj? `<div class="tt-card" style="background:${TT.colorFor(subj)}"><div>${subj}<small>${days[c]} Â· ${r+1}êµì‹œ</small></div></div>`:''}</div>`; } }
    document.getElementById('friendView').innerHTML = `
      <div class="muted" style="margin-bottom:8px">${u.name}(${u.grade}í•™ë…„)ì˜ ì‹œê°„í‘œ</div>
      <div class="tt-wrap"><div class="tt-hours">${Array.from({length:rows},(_,i)=>`<div class="h">${i+1}êµì‹œ</div>`).join('')}</div><div class="tt-grid">${gridHtml}</div></div>`;
  }
};

/* ========= News ========= */
function ViewNews(){
  const isAdmin = Auth.isAdmin();
  Router.mount.innerHTML = `
    <section class="section">
      <div class="split" style="align-items:center;justify-content:space-between">
        <h2>í‘œì„ ê³  ì†Œì‹</h2>
        ${isAdmin?`<span class="chip">ê¶Œí•œ: ê´€ë¦¬ì</span>`:`<span class="chip">ì½ê¸° ì „ìš©</span>`}
      </div>
      <div id="newsArea"></div>
      ${isAdmin?`
      <div class="card" style="margin-top:12px">
        <strong>ê¸°ì‚¬ ì‘ì„±</strong><div class="muted tiny">ê´€ë¦¬ì ê³„ì •: admin@pyoseon.hs.kr</div><div class="line"></div>
        <div class="split" style="gap:8px;align-items:center">
          <input id="nSection" placeholder="ì„¹ì…˜(ì˜ˆ: ìº í¼ìŠ¤/í•™ìƒíšŒ)" class="btn" style="flex:1"/>
          <input id="nTitle" placeholder="ì œëª©" class="btn" style="flex:2"/>
        </div>
        <div class="split" style="gap:8px;margin-top:8px">
          <input id="nLead" placeholder="ë¦¬ë“œ(ìš”ì•½ 1~2ë¬¸ì¥)" class="btn" style="flex:1"/>
          <input id="nThumb" placeholder="ì¸ë„¤ì¼ URL(ì„ íƒ)" class="btn" style="flex:1"/>
        </div>
        <textarea id="nBody" placeholder="ë³¸ë¬¸(ì¤„ë°”ê¿ˆ ìœ ì§€)" class="btn" style="width:100%;min-height:120px;margin-top:8px"></textarea>
        <div class="split" style="gap:8px;margin-top:8px;align-items:center">
          <button class="btn" onclick="News.insertTemplate()">í…œí”Œë¦¿</button>
          <button class="btn" onclick="News.sampleThumb()">ìƒ˜í”Œ ì¸ë„¤ì¼</button>
          <button class="btn pri" onclick="News.save()">ë°œí–‰</button>
        </div>
      </div>`:''}
    </section>`;
  News.initFromHash();
}
const News = {
  currentId:null,
  autoThumb(seed='NEWS'){
    const txt = encodeURIComponent(seed.slice(0,6).toUpperCase());
    return `data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' width='640' height='360'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='%230e2148'/><stop offset='100%' stop-color='%23122a54'/></linearGradient></defs><rect width='640' height='360' rx='16' fill='url(%23g)'/><text x='50%25' y='53%25' dominant-baseline='middle' text-anchor='middle' fill='%23ffffff' font-size='64' font-family='Segoe UI, Arial, sans-serif'>${txt}</text></svg>`;
  },
  readingTime(text){ const w=(text.trim().split(/\s+/).filter(Boolean).length)||0; const min=Math.max(1,Math.round(w/250)); return `${min}ë¶„ ì†Œìš”`; },
  when(ts){ if(!ts) return ''; const s=Math.floor((Date.now()-ts)/1000); if(s<60) return `${s}ì´ˆ ì „`; if(s<3600) return `${Math.floor(s/60)}ë¶„ ì „`; if(s<86400) return `${Math.floor(s/3600)}ì‹œê°„ ì „`; return `${Math.floor(s/86400)}ì¼ ì „`; },
  renderList(){
    const area=document.getElementById('newsArea'); const list=Store.get('news',[]).sort((a,b)=> (b.ts||0)-(a.ts||0));
    area.innerHTML = (list.length? `<div class="news-wrap">
      ${list.map(n=>`<article class="news-card" onclick="News.open('${n.id}')">
        <img class="news-thumb" alt="thumb" src="${n.thumb||this.autoThumb(n.section||'NEWS')}"/>
        <div>
          <div class="muted tiny">${n.section||'ì†Œì‹'} Â· <span>${n.date||''}</span></div>
          <h3 class="news-title">${CT.escape(n.title)}</h3>
          <div class="news-meta">ê´€ë¦¬ì Â· ${this.readingTime(n.body||'')} Â· ${this.when(n.ts)}</div>
          <p class="news-lead">${CT.escape(n.lead||'')}</p>
          ${Auth.isAdmin()?`<div class="tiny" style="margin-top:6px"><button class="btn" onclick="event.stopPropagation();News.remove('${n.id}')">ğŸ—‘ ì‚­ì œ</button></div>`:''}
        </div>
      </article>`).join('')}
    </div>` : `<div class="card"><div class="muted">ë°œí–‰ëœ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>`);
  },
  renderArticle(id){
    const area=document.getElementById('newsArea'); const n=(Store.get('news',[]).find(x=>x.id===id)); if(!n){ this.currentId=null; return this.renderList(); }
    area.innerHTML = `
      <article class="article">
        <img class="hero" alt="hero" src="${n.thumb||this.autoThumb(n.section||'NEWS')}"/>
        <div class="pad">
          <div class="muted tiny">${n.section||'ì†Œì‹'} Â· ${n.date||''} Â· ${this.readingTime(n.body||'')}</div>
          <h1>${CT.escape(n.title)}</h1>
          <div class="by">ê´€ë¦¬ì (${n.authorEmail})</div>
          <div class="body">${(n.body||'').replace(/</g,'&lt;')}</div>
          <div class="actions">
            <button class="btn" onclick="navigator.clipboard?.writeText(location.origin+location.pathname+'#news-${n.id}'); UI.toast('ë§í¬ ë³µì‚¬ë¨')">ğŸ”— ê³µìœ </button>
            <button class="btn" onclick="News.back()">â† ëª©ë¡ìœ¼ë¡œ</button>
            ${Auth.isAdmin()?`<button class="btn" onclick="News.remove('${n.id}')">ğŸ—‘ ì‚­ì œ</button>`:''}
          </div>
        </div>
      </article>`;
    location.hash = `news-${id}`;
  },
  open(id){ this.currentId=id; this.renderArticle(id); },
  back(){ this.currentId=null; location.hash='#news'; this.renderList(); },
  save(){
    if(!Auth.isAdmin()) return UI.toast('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤');
    const me=Auth.user();
    const section = document.getElementById('nSection').value.trim();
    const title   = document.getElementById('nTitle').value.trim();
    const lead    = document.getElementById('nLead').value.trim();
    const thumb   = document.getElementById('nThumb').value.trim();
    const body    = document.getElementById('nBody').value.trim();
    if(!title || !body) return UI.toast('ì œëª©/ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”');
    const list=Store.get('news',[]); const id=crypto.randomUUID?.() || Math.random().toString(36).slice(2);
    list.push({id, section, title, lead, thumb, body, authorEmail:me.email, authorName:me.name, date:fmtDate(now()), ts: Date.now()});
    Store.set('news', list); UI.toast('ë°œí–‰ ì™„ë£Œ'); this.currentId=null; ViewNews();
  },
  remove(id){
    if(!Auth.isAdmin()) return UI.toast('ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤');
    const list=Store.get('news',[]); Store.set('news', list.filter(x=>x.id!==id)); UI.toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤'); this.currentId=null; this.renderList();
  },
  initFromHash(){
    const h=location.hash; const m=h.match(/^#news-(.+)$/);
    if(m){ this.currentId=m[1]; this.renderArticle(this.currentId); }
    else { this.currentId=null; this.renderList(); }
  },
  insertTemplate(){
    const t = `ê¸°ì‚¬ ë¦¬ë“œ í•œ ë¬¸ì¥ìœ¼ë¡œ í•µì‹¬ ìš”ì•½.\n\n- ì†Œì œëª© 1\në‚´ìš© ë‹¨ë½ 1\n\n- ì†Œì œëª© 2\në‚´ìš© ë‹¨ë½ 2\n`;
    const el=document.getElementById('nBody'); el.value = (el.value? el.value+'\n':'') + t; el.focus();
  },
  sampleThumb(){
    const el=document.getElementById('nThumb'); el.value = this.autoThumb('NEWS');
  }
};

/* ========= Community ========= */
function ViewCommunity(){
  const c = CT; Router.mount.innerHTML = `
    <section class="section">
      <div class="ct-wrap">
        <div class="ct-topbar">
          <div class="ct-logo">Pyo<b>Gomo</b></div>
          <div class="ct-search"><input id="ctQ" placeholder="ê²€ìƒ‰ (ê¸€, ëŒ“ê¸€, ì‘ì„±ì)"/><button id="ctBtnSearch">ê²€ìƒ‰</button></div>
          <div class="muted tiny" id="ctWho">â€”</div>
        </div>
        <div class="ct-tabs" id="ctTabs"></div>
        <div>
          <div class="ct-composer">
            <div class="ct-avatar"></div>
            <input id="ctQuick" placeholder="ë¬´ìŠ¨ ìƒê° ì¤‘ì¸ê°€ìš”? (í´ë¦­í•˜ì—¬ ê¸€ì“°ê¸°)" readonly />
            <button class="btn pri" id="ctOpen">ê¸€ì“°ê¸°</button>
          </div>
          <div id="ctFeed" class="ct-feed"></div>
        </div>
      </div>
      <div class="card" style="margin-top:12px"><div class="muted tiny">ì»¤ë®¤ë‹ˆí‹° í•˜ë‹¨ ë°°ë„ˆ</div></div>
    </section>`;
  c.ui.init();
}
const CT = {
  key:'campustime_state_v1',
  get(){ try{ return JSON.parse(localStorage.getItem(this.key))||null }catch{ return null } },
  set(v){ localStorage.setItem(this.key, JSON.stringify(v)) },
  me(){ return Auth.user() },
  timeAgo(ts){ const s=Math.floor((Date.now()-ts)/1000); if(s<60)return `${s}ì´ˆ ì „`; if(s<3600)return `${Math.floor(s/60)}ë¶„ ì „`; if(s<86400)return `${Math.floor(s/3600)}ì‹œê°„ ì „`; return `${Math.floor(s/86400)}ì¼ ì „`; },
  escape(s){ return (s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]) ) },
  defaultBoards:['ììœ ê²Œì‹œíŒ','ì •ë³´ê²Œì‹œíŒ','ì§ˆë¬¸ê²Œì‹œíŒ','í™ë³´ê²Œì‹œíŒ','ë¹„ë°€ê²Œì‹œíŒ'],
  ui:{
    init(){
      if(!CT.get()) localStorage.setItem(CT.key, JSON.stringify({boards:CT.defaultBoards,activeBoard:'ì „ì²´',posts:[],noti:0}));
      this.state = CT.get(); this.renderTabs(); this.renderFeed(); this.bind();
      const u=CT.me(); document.getElementById('ctWho').textContent = u? `${u.name} (${u.email})` : 'â€”';
    },
    bind(){
      document.getElementById('ctOpen').onclick = ()=>this.openWrite();
      document.getElementById('ctQuick').onclick= ()=>this.openWrite();
      document.getElementById('ctBtnSearch').onclick = ()=>{ const q=document.getElementById('ctQ').value.trim(); this.renderFeed(q) };
      document.getElementById('ctQ').addEventListener('keydown',e=>{ if(e.key==='Enter') this.renderFeed(e.target.value.trim()) });
      document.getElementById('ctCancel').onclick = ()=> this.closeWrite();
      document.getElementById('ctSubmit').onclick = ()=> this.submit();
    },
    renderTabs(){
      const tabs=document.getElementById('ctTabs'); tabs.innerHTML='';
      const all=['ì „ì²´', ...this.state.boards];
      all.forEach(name=>{
        const el=document.createElement('button');
        el.className='ct-tab'+(this.state.activeBoard===name?' active':''); el.textContent=name;
        el.onclick=()=>{ this.state.activeBoard=name; CT.set(this.state); this.renderTabs(); this.renderFeed(); };
        tabs.appendChild(el);
      });
    },
    renderFeed(query=''){
      const feed=document.getElementById('ctFeed'); let posts=[...this.state.posts];
      if(this.state.activeBoard!=='ì „ì²´') posts=posts.filter(p=>p.board===this.state.activeBoard);
      if(query){ const k=query.toLowerCase(); posts=posts.filter(p=> (p.title+p.body+p.authorName).toLowerCase().includes(k) || (p.comments||[]).some(c=>(c.who+c.text).toLowerCase().includes(k))); }
      feed.innerHTML = posts.length? '' : `<div class="ct-empty">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
      posts.forEach(p=> feed.appendChild(this.postCard(p)) );
    },
    postCard(p){
      const me=CT.me(); const canDel = Auth.isAdmin() || (me && me.email===p.authorEmail);
      const myReaction = (p.reactions && Object.entries(p.reactions).find(([emo,arr])=>arr.includes(me?.email||'')))?.[0] || null;
      const count = (emo)=> (p.reactions?.[emo]?.length||0);
      const emolist = ['ğŸ‘','ğŸ˜‚','ğŸ¥¹','ğŸ‰','â¤ï¸'];
      const card=document.createElement('article'); card.className='ct-card';
      card.innerHTML = `
        <div class="head">
          <div class="ct-avatar"></div>
          <div>
            <div><b>${CT.escape(p.authorName)}</b> Â· <span class="ct-meta">${CT.escape(p.board)}</span></div>
            <div class="ct-meta">${CT.timeAgo(p.ts)}</div>
          </div>
        </div>
        ${p.title?`<div class="ct-title">${CT.escape(p.title)}</div>`:''}
        <div class="ct-body">${CT.escape(p.body)}</div>
        <div class="ct-actions">
          <div class="ct-reactions">
            ${emolist.map(emo=>`<button data-emo="${emo}" class="${myReaction===emo?'active':''}">${emo} <span>${count(emo)}</span></button>`).join('')}
          </div>
          <button data-act="comment">ğŸ’¬ <span>${(p.comments||[]).length}</span></button>
          <button data-act="share">ğŸ”— ê³µìœ </button>
          ${canDel?`<button data-act="del" style="margin-left:auto">ğŸ—‘ ì‚­ì œ</button>`:''}
        </div>
        <div class="ct-comments">
          ${(p.comments||[]).map(c=>`
            <div class="ct-comment">
              <div class="ct-avatar"></div>
              <div class="ct-bubble"><div class="who">${CT.escape(c.who)}</div>${CT.escape(c.text)}</div>
            </div>`).join('')}
          <div class="ct-comment">
            <div class="ct-avatar"></div>
            <div style="display:flex;gap:8px;width:100%">
              <input placeholder="ëŒ“ê¸€ ì“°ê¸°" style="flex:1;background:var(--chip);border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:12px" />
              <button class="ctAddCmt" style="background:var(--pri);color:#031020;border:0;padding:8px 12px;border-radius:12px;font-weight:700">ë“±ë¡</button>
            </div>
          </div>
        </div>`;
      // Reaction handlers
      card.querySelectorAll('.ct-reactions button').forEach(btn=>{
        btn.onclick=()=>{
          const emo=btn.dataset.emo; const me=CT.me(); if(!me){ UI.toast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤'); return; }
          p.reactions = p.reactions || {};
          // remove existing my reaction
          Object.keys(p.reactions).forEach(k=>{
            p.reactions[k] = (p.reactions[k]||[]).filter(e=>e!==me.email);
          });
          // toggle if same clicked
          if(myReaction!==emo){
            p.reactions[emo] = p.reactions[emo]||[]; p.reactions[emo].push(me.email);
          }
          CT.set(this.state); this.renderFeed();
        };
      });
      // Other actions
      const [btnCmt, btnShare, btnDel] = card.querySelectorAll('.ct-actions button[data-act]');
      if(btnCmt) btnCmt.onclick = ()=> card.querySelector('.ct-comments input').focus();
      if(btnShare) btnShare.onclick= ()=>{ navigator.clipboard?.writeText(location.origin+location.pathname+'#post-'+p.id); UI.toast('ë§í¬ ë³µì‚¬ë¨'); };
      if(btnDel) btnDel.onclick = ()=>{ if(confirm('ì´ ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')){ this.state.posts=this.state.posts.filter(x=>x.id!==p.id); CT.set(this.state); this.renderFeed(); } };
      // comment add
      card.querySelector('.ctAddCmt').onclick = ()=>{
        const input=card.querySelector('.ct-comments input'); const text=input.value.trim(); if(!text) return;
        p.comments=p.comments||[]; p.comments.push({who:(CT.me()?.name||'ìµëª…'), text}); input.value=''; CT.set(this.state); this.renderFeed();
      };
      return card;
    },
    openWrite(){
      const u=CT.me(); if(!u){ UI.toast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤'); return; }
      document.getElementById('ctBoard').innerHTML = this.state.boards.map(b=>`<option>${b}</option>`).join('');
      document.getElementById('ctTitle').value=''; document.getElementById('ctBody').value=''; document.getElementById('ctAuthor').value = u? u.name : 'ìµëª…';
      document.getElementById('ctModal').style.display='grid';
    },
    closeWrite(){ document.getElementById('ctModal').style.display='none'; },
    submit(){
      const u=CT.me(); if(!u){ UI.toast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤'); return; }
      const post = {
        id: crypto.randomUUID?.() || Math.random().toString(36).slice(2),
        board: document.getElementById('ctBoard').value,
        title: document.getElementById('ctTitle').value.trim(),
        body: document.getElementById('ctBody').value.trim(),
        authorName: document.getElementById('ctAuthor').value.trim() || u.name || 'ìµëª…',
        authorEmail: u.email,
        ts: Date.now(), reactions:{}, comments:[]
      };
      if(!post.body) return UI.toast('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
      this.state.posts.unshift(post); this.state.noti=(this.state.noti||0)+1; CT.set(this.state); this.closeWrite(); this.renderFeed(); UI.toast('ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
    }
  }
};

/* ========= Study Apps ========= */
function svgDataUri(title,a='#0e2148',b='#122a54'){
  const t=String(title||'APP').slice(0,10);
  const svg=`<?xml version="1.0"?>
<svg xmlns="http://www.w3.org/2000/svg" width="640" height="360">
  <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
    <stop offset="0%" stop-color="${a}"/><stop offset="100%" stop-color="${b}"/>
  </linearGradient></defs>
  <rect width="640" height="360" rx="16" fill="url(#g)"/>
  <text x="50%" y="53%" dominant-baseline="middle" text-anchor="middle" fill="#ffffff" font-size="48" font-family="Segoe UI, Arial, sans-serif">${t.replace(/&/g,'&amp;')}</text>
</svg>`;
  return 'data:image/svg+xml;charset=UTF-8,'+encodeURIComponent(svg);
}
function ViewStudy(){
  const rec = [
    {name:'Desmos Graphing Calculator', desc:'í•¨ìˆ˜ ê·¸ë˜í”„/ë¯¸ì ë¶„ ì‹œê°í™”', url:'https://www.desmos.com/calculator', thumb:svgDataUri('Desmos') , similar:['GeoGebra','Wolfram Alpha'], tip:'ì¢Œí‘œì¶• ë²”ìœ„ë¥¼ ìˆ˜ì‹ìœ¼ë¡œ ê³ ì •í•˜ê³  ìŠ¬ë¼ì´ë”ë¡œ ë§¤ê°œë³€ìˆ˜ íƒìƒ‰.'},
    {name:'Anki', desc:'ìŠ¤í˜ì´ìŠ¤ë“œ ë¦¬í•(ì•”ê¸° ì¹´ë“œ)', url:'https://apps.ankiweb.net/', thumb:svgDataUri('Anki','#173b2a','#0f6c3f'), similar:['Quizlet','Remnote'], tip:'ì¹´ë“œì— â€œìµœì†Œí•œì˜ ì •ë³´â€ ì›ì¹™ ì ìš© â†’ íšŒìƒ ë‚œì´ë„â†“, ìœ ì§€ìœ¨â†‘.'},
    {name:'Forest', desc:'í¬ëª¨ë„ë¡œ ì§‘ì¤‘ íƒ€ì´ë¨¸', url:'https://www.forestapp.cc/', thumb:svgDataUri('Forest','#203a1a','#2a5a1f'), similar:['Focus To-Do','Study Bunny'], tip:'ì¹œêµ¬ì™€ ê³µë™ì„¸ì…˜ìœ¼ë¡œ ì±…ì„ê° ìƒìŠ¹. ê³µë¶€Â·íœ´ì‹ ë¹„ìœ¨ 50:10 ì¶”ì²œ.'},
    {name:'Notion', desc:'ë…¸íŠ¸/DB/ê³¼ì œ ê´€ë¦¬', url:'https://www.notion.so/', thumb:svgDataUri('Notion','#1b1b1b','#333333'), similar:['Obsidian','Evernote'], tip:'ê³¼ì œDB + ì¹¸ë°˜ ë³´ë“œ + í…œí”Œë¦¿ ë²„íŠ¼ìœ¼ë¡œ ì£¼ì°¨ë³„ ë£¨í‹´ ìë™í™”.'},
    {name:'GeoGebra', desc:'ëŒ€ìˆ˜/ê¸°í•˜ ë„êµ¬ ëª¨ìŒ', url:'https://www.geogebra.org/', thumb:svgDataUri('GeoGebra','#0f2b63','#1c4ca3'), similar:['Desmos','Wolfram Alpha'], tip:'ë²¡í„°/í–‰ë ¬ ì—°ì‚°ì˜ ë‹¨ê³„ë³„ ì‹œê°í™”ë¡œ ì¦ëª… ì§ê´€ ì–»ê¸°.'},
    {name:'Wolfram Alpha', desc:'ê³„ì‚° ì§€ì‹ ì—”ì§„', url:'https://www.wolframalpha.com/', thumb:svgDataUri('Wolfram','#682300','#a33d00'), similar:['Symbolab','Mathway'], tip:'ì¿¼ë¦¬ëŠ” â€œìì—°ì–´+ìˆ˜ì‹â€ í˜¼í•©ì´ ì¢‹ìŒ. ì˜ˆ: â€œlimit sin x / x as x->0â€.'},
    {name:'Symbolab', desc:'í•´ì„¤ í¬í•¨ ìˆ˜í•™ í’€ì´', url:'https://www.symbolab.com/', thumb:svgDataUri('Symbolab','#11202f','#1d3b5a'), similar:['Mathway','Wolfram Alpha'], tip:'í’€ì´ ë‹¨ê³„ ë¹„êµ(ì—¬ëŸ¬ í•´ë²•)ë¡œ ì•½ì  ìœ í˜• íŒŒì•….'},
    {name:'Pomofocus', desc:'ì›¹ í¬ëª¨ë„ë¡œ íƒ€ì´ë¨¸', url:'https://pomofocus.io/', thumb:svgDataUri('Pomofocus','#4a0d0d','#7a1919'), similar:['Forest','Marinara Timer'], tip:'í•˜ë£¨ 10ì„¸ì…˜ ëª©í‘œ, ì£¼ê°„ ì„±ê³¼ ê·¸ë˜í”„ í™•ì¸ â†’ ìŠµê´€ ê³ ì°©.'}
  ];
  Store.set('studyapps', rec);
  const apps=Store.get('studyapps',[]);
  Router.mount.innerHTML = `
    <section class="section">
      <h2>í•™ì—… ë„ì›€ ì•± & ì‚¬ì´íŠ¸</h2>
      <div class="app-grid" id="appGrid">
        ${apps.map((a,i)=>`
          <div class="app-card">
            <img class="thumb" src="${a.thumb}" alt="${a.name}"/>
            <div style="font-weight:800">${a.name}</div>
            <div class="muted tiny">${a.desc}</div>
            <div style="margin-top:auto;display:flex;justify-content:space-between;align-items:center">
              <span class="chip">ë°”ë¡œê°€ê¸°</span>
              <button class="btn pri" onclick="Apps.open(${i})">â¡ï¸</button>
            </div>
          </div>`).join('')}
      </div>
      <div id="appDetail"></div>
    </section>`;
}
const Apps = {
  open(i){
    const a=(Store.get('studyapps',[])[i]); if(!a) return;
    const det=document.getElementById('appDetail');
    det.innerHTML = `
      <div class="app-detail">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>${a.name}</strong><div class="muted tiny" style="margin-top:4px">${a.desc}</div></div>
          <a class="btn pri" href="${a.url}" target="_blank" rel="noopener">ì‚¬ì´íŠ¸ ì—´ê¸°</a>
        </div>
        <div class="line"></div>
        <div class="muted">ìœ ì‚¬í•œ ì¶”ì²œ ì•±</div>
        <div class="split" style="margin-top:8px">${(a.similar||[]).map(s=>`<span class="chip">${s}</span>`).join('')||'<span class="muted tiny">ì—†ìŒ</span>'}</div>
        ${a.tip?`<div class="line"></div><div class="tiny muted">í™œìš© íŒ</div><div style="margin-top:6px">${CT.escape(a.tip)}</div>`:''}
      </div>`;
  }
};

/* ========= My Page (ì„¤ì •) ========= */
function ViewMe(){
  const u=Auth.user(); if(!u){ location.hash='#home'; return showApp(false); }
  Router.mount.innerHTML = `
    <section class="section">
      <h2>ì„¤ì •</h2>
      <div class="cards">
        <div class="card half">
          <strong>í”„ë¡œí•„</strong><div class="line"></div>
          <div class="tiny muted" style="margin-bottom:6px">ê³„ì • / í•™êµ ì •ë³´</div>
          <div class="split">
            <div class="chip">ì´ë¦„: ${CT.escape(u.name)}</div>
            <div class="chip">ì´ë©”ì¼: ${CT.escape(u.email)}</div>
            <div class="chip">í•™ë…„: ${u.grade||'-'}</div>
            <div class="chip">ë°˜: ${u.classNo||'-'}</div>
            <div class="chip">ë²ˆí˜¸: ${u.studentNo||'-'}</div>
            <div class="chip">ì—­í• : ${Auth.isAdmin()?'ê´€ë¦¬ì':'ì¼ë°˜'}</div>
          </div>
          <div class="line"></div>
          <button class="btn" onclick="(Auth.logout(), UI.toast('ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ'), location.reload())">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div class="card half">
          <strong>ê°œì¸í™”</strong><div class="line"></div>
          <div class="split">
            <label class="chip"><input type="checkbox" id="setTheme" ${u.settings?.theme==='dark'?'checked':''} onchange="Settings.toggleTheme(this.checked)"> ë‹¤í¬ í…Œë§ˆ</label>
            <label class="chip"><input type="checkbox" id="setPNoti" ${u.settings?.pushPersonal!==false?'checked':''} onchange="Settings.toggle('pushPersonal',this.checked)"> ê°œì¸ ì•Œë¦¼</label>
            <label class="chip"><input type="checkbox" id="setGNoti" ${u.settings?.pushGlobal!==false?'checked':''} onchange="Settings.toggle('pushGlobal',this.checked)"> ì „ì²´ ì•Œë¦¼</label>
            <label class="chip"><input type="checkbox" id="setShareTT" ${u.settings?.shareTimetable?'checked':''} onchange="Settings.toggle('shareTimetable',this.checked)"> ì‹œê°„í‘œ ê³µìœ </label>
          </div>
        </div>

        <div class="card half">
          <strong>ë³´ì•ˆ</strong><div class="line"></div>
          <div class="tiny muted">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½(ë¡œì»¬ ë°ëª¨): ë³€ê²½ ì¦‰ì‹œ ì €ì¥</div>
          <div class="split" style="margin-top:6px">
            <input id="pwNew" type="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸(8ì ì´ìƒ)" class="btn" style="flex:1"/>
            <button class="btn pri" onclick="Settings.changePw()">ë³€ê²½</button>
          </div>
        </div>

        <div class="card half">
          <strong>ë°ì´í„° ê´€ë¦¬</strong><div class="line"></div>
          <div class="split">
            <button class="btn" onclick="localStorage.clear(); UI.toast('ë¡œì»¬ ë°ì´í„° ì´ˆê¸°í™”'); location.reload()">ë¡œì»¬ ì´ˆê¸°í™”</button>
          </div>
        </div>
      </div>
    </section>`;
}
const Settings = {
  saveUser(u){ const users=Store.get('users',[]).map(x=>x.email===u.email?u:x); Store.set('users',users); },
  toggleTheme(dark){ const u=Auth.user(); u.settings=u.settings||{}; u.settings.theme= dark?'dark':'light'; this.saveUser(u); applyUserTheme(); UI.toast('í…Œë§ˆ ì €ì¥'); },
  toggle(key,val){ const u=Auth.user(); u.settings=u.settings||{}; u.settings[key]=val; this.saveUser(u); UI.toast('ì €ì¥ë¨'); },
  async changePw(){ const u=Auth.user(); const pw=document.getElementById('pwNew').value; if((pw||'').length<8){ UI.toast('8ì ì´ìƒ ì…ë ¥'); return; } u.pwHash=await pwHashFor(u.email,pw); this.saveUser(u); UI.toast('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ'); document.getElementById('pwNew').value=''; }
};

/* ========= Notifications ========= */
const Noti = {
  list(){ return Store.get('notifs',{personal:[],global:[]}) },
  set(v){ Store.set('notifs', v) },
  add(kind, text){ const n=this.list(); const item={id:crypto.randomUUID?.()||Math.random().toString(36).slice(2), text, ts:Date.now(), read:false};
                   n[kind]=[item, ...n[kind]]; this.set(n); this.updateBadge(); },
  broadcast(text){ if(!Auth.isAdmin()) return; this.add('global', text); UI.toast('ì „ì²´ ì•Œë¦¼ ë°œì†¡'); },
  unreadCount(){ const n=this.list(); const p=n.personal.filter(x=>!x.read).length; const g=n.global.filter(x=>!x.read).length; return p+g; },
  updateBadge(){ const c=this.unreadCount(); const badge=document.getElementById('bellBadge'); badge.textContent=c; badge.style.display = c>0?'inline-block':'none'; },
  openPanel(){
    const panel=document.getElementById('notiPanel'); panel.style.display = panel.style.display==='block'?'none':'block';
    document.getElementById('notiAdmin').style.display = Auth.isAdmin()? 'block':'none';
    this.renderList('personal');
  },
  renderList(kind){
    const box=document.getElementById('notiList'); const n=this.list()[kind]; const fmt=(ts)=>{const s=Math.floor((Date.now()-ts)/1000); if(s<60)return s+'ì´ˆ ì „'; if(s<3600)return Math.floor(s/60)+'ë¶„ ì „'; if(s<86400)return Math.floor(s/3600)+'ì‹œê°„ ì „'; return Math.floor(s/86400)+'ì¼ ì „'};
    if(!n.length){ box.innerHTML='<div class="empty">ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; } else {
      box.innerHTML = `
        <div class="split" style="justify-content:flex-end;padding:0 4px 4px"><button class="btn" onclick="Noti.clear('${kind}')">í‘œì‹œëœ ëª©ë¡ ì‚­ì œ</button></div>
        ${n.map(i=>`<div class="item"><div>${CT.escape(i.text)}<div class="tiny muted" style="margin-top:4px">${fmt(i.ts)}</div></div><button class="del" onclick="Noti.remove('${kind}','${i.id}')">ì‚­ì œ</button></div>`).join('')}`;
      // mark read
      const all=this.list(); all[kind]=all[kind].map(x=>({...x, read:true})); this.set(all); this.updateBadge();
    }
  },
  remove(kind,id){ const all=this.list(); all[kind]=all[kind].filter(x=>x.id!==id); this.set(all); this.renderList(kind); },
  clear(kind){ const all=this.list(); all[kind]=[]; this.set(all); this.renderList(kind); }
};

/* ========= Search ========= */
function doSearch(q){
  const inText=(s)=> (s||'').toLowerCase().includes(q.toLowerCase());
  const notices=Store.get('notices',[]).filter(n=>inText(n.title));
  const news=Store.get('news',[]).filter(n=>inText(n.title)||inText(n.body)||inText(n.lead)||inText(n.section));
  const posts=(CT.get()?.posts||[]).filter(p=>inText(p.title)||inText(p.body)||inText(p.authorName));
  const library=Store.get('library',[]).filter(l=>inText(l.title));
  const res=[...notices.map(n=>`[ê³µì§€] ${n.title}`), ...news.map(n=>`[ë‰´ìŠ¤] ${n.title}`), ...posts.map(p=>`[ê²Œì‹œê¸€] ${p.title? p.title+' â€” ' : ''}${(p.body||'').slice(0,24)}â€¦`), ...library.map(l=>`[ë„ì„œê´€] ${l.title}`)];
  document.getElementById('searchResult').innerHTML = res.length? res.map(r=>`<div>${CT.escape(r)}</div>`).join('') : '<span class="muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
}

/* ========= Top buttons & Admin bind ========= */
document.getElementById('btnSearch').addEventListener('click', UI.showSearch);
document.getElementById('btnBell').addEventListener('click', ()=> Noti.openPanel());
document.getElementById('btnMy').addEventListener('click', ()=>{ location.hash='#me'; Router.render(); });

document.getElementById('notiPanel').querySelectorAll('.tabs button').forEach(btn=>{
  btn.onclick=()=>{ document.querySelectorAll('#notiPanel .tabs button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); Noti.renderList(btn.dataset.kind); };
});
document.getElementById('btnBroadcast').onclick = ()=>{ const t=document.getElementById('notiMsg').value.trim(); if(!t) return; Noti.broadcast(t); document.getElementById('notiMsg').value=''; };
document.getElementById('btnClearAll').onclick = ()=>{ if(!Auth.isAdmin()) return; const all=Noti.list(); all.global=[]; Noti.set(all); Noti.renderList('global'); };

document.getElementById('btnAdmin').addEventListener('click', ()=>{ if(!Auth.isAdmin()) return; document.getElementById('adminPanel').style.display='block'; });
document.getElementById('btnAdminClose').addEventListener('click', ()=>{ document.getElementById('adminPanel').style.display='none'; });
document.getElementById('admAddBoard').addEventListener('click', ()=>{
  if(!Auth.isAdmin()) return; const name=document.getElementById('admBoardName').value.trim(); if(!name) return;
  const st=CT.get(); if(st.boards.includes(name)) return UI.toast('ì´ë¯¸ ì¡´ì¬');
  st.boards.push(name); localStorage.setItem(CT.key, JSON.stringify(st)); UI.toast('ì¶”ê°€ ì™„ë£Œ');
});
document.getElementById('admResetBoards').addEventListener('click', ()=>{
  if(!Auth.isAdmin()) return; const st=CT.get(); st.boards=CT.defaultBoards; localStorage.setItem(CT.key, JSON.stringify(st)); UI.toast('ë³µì› ì™„ë£Œ');
});
document.getElementById('admClearDemo').addEventListener('click', ()=>{
  if(!Auth.isAdmin()) return; localStorage.removeItem(CT.key); UI.toast('ì»¤ë®¤ë‹ˆí‹° ì´ˆê¸°í™” ì™„ë£Œ');
});
document.getElementById('admGiveSampleNews').addEventListener('click', ()=>{
  if(!Auth.isAdmin()) return; const me=Auth.user(); const list=Store.get('news',[]); const id=crypto.randomUUID?.() || Math.random().toString(36).slice(2);
  list.push({id, section:'ê³µì§€', title:'ìƒ˜í”Œ ê¸°ì‚¬', lead:'ìƒ˜í”Œ ë¦¬ë“œ', thumb:News.autoThumb('SAMPLE'), body:'ìƒ˜í”Œ ë³¸ë¬¸ì…ë‹ˆë‹¤.', authorEmail:me.email, authorName:me.name, date:fmtDate(now()), ts: Date.now()});
  Store.set('news', list); UI.toast('ìƒ˜í”Œ ê¸°ì‚¬ ë°œí–‰'); if(location.hash==='#news') ViewNews();
});

/* ========= Hash & boot ========= */
window.addEventListener('hashchange', ()=>Router.render());
showApp(true); // auto login if available
</script>
</body>
</html>